# Complete Authentication Flows - User Experience
**SAP GRC Platform - Enhanced Multi-Factor Authentication System**

---

## ðŸ“‹ TABLE OF CONTENTS

1. [Flow 1: New Tenant Onboarding](#flow-1-new-tenant-onboarding)
2. [Flow 2: First Admin Login (Post-Onboarding)](#flow-2-first-admin-login-post-onboarding)
3. [Flow 3: Regular Login - Password Only](#flow-3-regular-login---password-only)
4. [Flow 4: Login with MFA (TOTP)](#flow-4-login-with-mfa-totp)
5. [Flow 5: Login with Passkey](#flow-5-login-with-passkey)
6. [Flow 6: Passwordless Login (Passkey Only)](#flow-6-passwordless-login-passkey-only)
7. [Flow 7: New Device/Location Detection](#flow-7-new-devicelocation-detection)
8. [Flow 8: High-Risk Login (Requires MFA)](#flow-8-high-risk-login-requires-mfa)
9. [Flow 9: Max Sessions Exceeded](#flow-9-max-sessions-exceeded)
10. [Flow 10: Password Change (Revokes All Sessions)](#flow-10-password-change-revokes-all-sessions)

---

## FLOW 1: New Tenant Onboarding

**Scenario:** Company wants to use the SAP GRC Platform for the first time

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NEW TENANT ONBOARDING FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Visit /signup      â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Fill Form:         â”‚                            â”‚
 â”‚     - Company Name     â”‚                            â”‚
 â”‚     - Admin Email      â”‚                            â”‚
 â”‚     - Admin Name       â”‚                            â”‚
 â”‚     - Password         â”‚                            â”‚
 â”‚     - SAP Connection   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Validate Email Unique  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚     âœ… Email Available     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Test SAP Connection    â”‚
 â”‚                        â”‚    (ping S/4HANA)          â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. Create Tenant Record   â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚     tenantId: uuid()       â”‚
 â”‚                        â”‚     status: ACTIVE         â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  6. Create Admin User      â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚     userId: uuid()         â”‚
 â”‚                        â”‚     roles: ['admin']       â”‚
 â”‚                        â”‚     passwordHash: bcrypt() â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Run Service Discovery  â”‚
 â”‚                        â”‚    (find available OData)  â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Create Capability      â”‚
 â”‚                        â”‚     Profile                â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚     - SoD: available       â”‚
 â”‚                        â”‚     - GL Anomaly: yes      â”‚
 â”‚                        â”‚     - Invoice: yes         â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Send Welcome Email     â”‚
 â”‚                        â”‚    Template: user-invitation
 â”‚  <- ðŸ“§ Welcome Email! â”‚                            â”‚
 â”‚    "Click to activate" â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  10. Success Page:     â”‚                            â”‚
 â”‚      "Check email to   â”‚                            â”‚
 â”‚       complete setup"  â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  11. Click Email Link  â”‚                            â”‚
 â”‚      /activate?token=xxâ”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚  12. Verify Token          â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚     âœ… Valid Token         â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  13. Mark Email Verified   â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚     emailVerified: true    â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚  14. Redirect:         â”‚                            â”‚
 â”‚      "/login"          â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… ONBOARDING COMPLETE - READY TO LOGIN           â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DATABASE STATE AFTER ONBOARDING:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tenant Table:                           â”‚
â”‚   tenantId: "acme-corp-uuid"            â”‚
â”‚   companyName: "Acme Corp"              â”‚
â”‚   status: ACTIVE                        â”‚
â”‚   sapConnection: { baseUrl, auth }      â”‚
â”‚                                         â”‚
â”‚ User Table:                             â”‚
â”‚   userId: "admin-uuid"                  â”‚
â”‚   email: "admin@acme.com"               â”‚
â”‚   tenantId: "acme-corp-uuid"            â”‚
â”‚   roles: ["admin"]                      â”‚
â”‚   passwordHash: "$2b$12$..."           â”‚
â”‚   emailVerified: true                   â”‚
â”‚   mfaEnabled: false (not set up yet)   â”‚
â”‚                                         â”‚
â”‚ TenantCapability Table:                 â”‚
â”‚   tenantId: "acme-corp-uuid"            â”‚
â”‚   capabilities: {                       â”‚
â”‚     sodAnalysis: true,                  â”‚
â”‚     glAnomaly: true,                    â”‚
â”‚     invoiceMatching: true               â”‚
â”‚   }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Visit signup page
2. ðŸ“ Fill out form (5 minutes)
3. â³ Wait for SAP connection test (10 seconds)
4. âœ… See success message
5. ðŸ“§ Check email (1 minute)
6. ðŸ”— Click activation link
7. âž¡ï¸ Redirected to login

**Total Time:** ~7 minutes

---

## FLOW 2: First Admin Login (Post-Onboarding)

**Scenario:** Admin logs in for the first time after onboarding

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIRST ADMIN LOGIN FLOW                           â”‚
â”‚              (No MFA Set Up Yet, New Device)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Visit /login       â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Enter Credentials: â”‚                            â”‚
 â”‚     Email: admin@acme  â”‚                            â”‚
 â”‚     Password: â€¢â€¢â€¢â€¢â€¢â€¢   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Lookup User by Email   â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚    User: admin@acme.com    â”‚
 â”‚                        â”‚    tenantId: acme-corp     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Verify Password (bcrypt)
 â”‚                        â”‚    âœ… Password Correct     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. Device Fingerprinting  â”‚
 â”‚                        â”‚    - Parse User-Agent      â”‚
 â”‚                        â”‚    - Generate Hash         â”‚
 â”‚                        â”‚    deviceId: "chrome-mac-xx"
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  6. Get Location (GeoIP)   â”‚
 â”‚                        â”‚    IP: 203.45.67.89        â”‚
 â”‚                        â”‚    Location: "Kuala Lumpur"â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Check Risk (RiskAnalyzer)
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query LoginAttempt table  â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  No history â†’ NEW USER     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  Risk Score: 35 (MEDIUM)   â”‚
 â”‚                        â”‚  - New Device: +20         â”‚
 â”‚                        â”‚  - New Location: +15       â”‚
 â”‚                        â”‚  - No Failed Attempts: +0  â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Check MFA Status       â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  mfaEnabled: false âŒ      â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  ðŸ’¡ Decision: Allow login  â”‚
 â”‚                        â”‚     but recommend MFA setupâ”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Create Session         â”‚
 â”‚                        â”‚    (SessionManager)        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  UserSession:              â”‚
 â”‚                        â”‚    sessionId: uuid()       â”‚
 â”‚                        â”‚    userId: admin-uuid      â”‚
 â”‚                        â”‚    deviceId: chrome-mac-xx â”‚
 â”‚                        â”‚    location: "KL, Malaysia"â”‚
 â”‚                        â”‚    ipAddress: 203.45.67.89 â”‚
 â”‚                        â”‚    createdAt: now()        â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  10. Store in Redis        â”‚
 â”‚                        â”‚      (for fast lookup)     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  11. Log LoginAttempt      â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  status: SUCCESS           â”‚
 â”‚                        â”‚  riskScore: 35             â”‚
 â”‚                        â”‚  device: chrome-mac-xx     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  12. Generate JWT Token    â”‚
 â”‚                        â”‚      {                     â”‚
 â”‚                        â”‚        userId: admin-uuid  â”‚
 â”‚                        â”‚        tenantId: acme-corp â”‚
 â”‚                        â”‚        sessionId: uuid     â”‚
 â”‚                        â”‚        roles: ['admin']    â”‚
 â”‚                        â”‚      }                     â”‚
 â”‚                        â”‚                            â”‚
 â”‚  13. Response:         â”‚                            â”‚
 â”‚      {                 â”‚                            â”‚
 â”‚        token: "eyJ..." â”‚                            â”‚
 â”‚        user: {...}     â”‚                            â”‚
 â”‚        mfaRequired: false                           â”‚
 â”‚        sessionId: "uuid"                            â”‚
 â”‚      }                 â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  14. Redirect:         â”‚                            â”‚
 â”‚      /dashboard        â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
 â”‚  â”‚  ðŸŽ‰ WELCOME TO YOUR DASHBOARD!       â”‚          â”‚
 â”‚  â”‚                                      â”‚          â”‚
 â”‚  â”‚  âš ï¸  BANNER: "Secure your account!" â”‚          â”‚
 â”‚  â”‚      "Set up MFA for better security"â”‚          â”‚
 â”‚  â”‚      [Set Up MFA] button            â”‚          â”‚
 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
 â”‚                        â”‚                            â”‚
 â”‚  15. (Optional) Click  â”‚                            â”‚
 â”‚      "Set Up MFA"      â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚      â†’ Go to FLOW 4 (MFA Setup)                    â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REDIS STATE AFTER LOGIN:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ session:admin-uuid                      â”‚
â”‚   {                                     â”‚
â”‚     sessionId: "session-uuid",          â”‚
â”‚     userId: "admin-uuid",               â”‚
â”‚     deviceId: "chrome-mac-xx",          â”‚
â”‚     location: "Kuala Lumpur",           â”‚
â”‚     createdAt: "2025-10-23T10:00:00Z",  â”‚
â”‚     lastActivityAt: "2025-10-23T10:00:00Z"
â”‚   }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Visit login page
2. âŒ¨ï¸ Enter email + password
3. â³ Wait 1-2 seconds
4. âœ… Logged in! Redirected to dashboard
5. âš ï¸ See banner: "Set up MFA" (recommended)

**Total Time:** ~30 seconds

---

## FLOW 3: Regular Login - Password Only

**Scenario:** User with NO MFA set up, logging in from trusted device

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REGULAR LOGIN - PASSWORD ONLY                    â”‚
â”‚                  (Trusted Device, Same Location)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Visit /login       â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Enter Credentials  â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Verify Password âœ…     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Device Fingerprint     â”‚
 â”‚                        â”‚     deviceId: chrome-mac-xxâ”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. Check Device History   â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: TrustedDevice      â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚    AND deviceId = chrome-mac
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  âœ… FOUND - Trusted Device â”‚
 â”‚                        â”‚     lastUsed: 2 days ago   â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  6. Risk Score: 10 (LOW)   â”‚
 â”‚                        â”‚     - Known Device: +0     â”‚
 â”‚                        â”‚     - Same Location: +0    â”‚
 â”‚                        â”‚     - No Failures: +0      â”‚
 â”‚                        â”‚     - Good History: -10    â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Check Active Sessions  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: UserSession        â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚    AND isActive = true     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  Found: 1 session (mobile) â”‚
 â”‚                        â”‚  Limit: 2 max â†’ OK âœ…      â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Create New Session     â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Session 2 of 2 created    â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Update Trusted Device  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  lastUsed: now()           â”‚
 â”‚                        â”‚  loginCount: +1            â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚  10. Login Success!    â”‚                            â”‚
 â”‚      Token: "eyJ..."   â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  11. Redirect: /dashboard                          â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN - NO CHALLENGES!                     â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Visit login page
2. âŒ¨ï¸ Enter credentials
3. âœ… Instant login (< 1 second)

**Total Time:** ~5 seconds

---

## FLOW 4: Login with MFA (TOTP)

**Scenario:** User has TOTP enabled, logging in from trusted device

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOGIN WITH MFA (TOTP)                            â”‚
â”‚             (User has Google Authenticator set up)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Visit /login       â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Enter Email/Pass   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Verify Password âœ…     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Check MFA Status       â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: UserMFAConfig      â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  totpEnabled: true âœ…      â”‚
 â”‚                        â”‚  preferredMethod: "totp"   â”‚
 â”‚                        â”‚                            â”‚
 â”‚  5. Show MFA Challenge â”‚                            â”‚
 â”‚     Page:              â”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
 â”‚     â”‚  ðŸ”’ Two-Factor Authenticationâ”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  Enter 6-digit code from     â”‚               â”‚
 â”‚     â”‚  your authenticator app:     â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  [___][___][___]-[___][___][___]            â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  [Verify Code]               â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  Can't access? Use backup code              â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  6. Open Google Auth   â”‚                            â”‚
 â”‚     on Phone ðŸ“±        â”‚                            â”‚
 â”‚     Code shown: 123456 â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  7. Enter Code: 123456 â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Get TOTP Secret        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: UserMFAConfig      â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  totpSecret: "BASE32..."   â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Verify TOTP Code       â”‚
 â”‚                        â”‚    (TOTPService.verify())  â”‚
 â”‚                        â”‚    Input: 123456           â”‚
 â”‚                        â”‚    Secret: "BASE32..."     â”‚
 â”‚                        â”‚    Time window: Â±1 (30s)   â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚    âœ… CODE VALID!          â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  10. Check Rate Limit      â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: MFARateLimit       â”‚
 â”‚                        â”‚  attempts: 1 of 5          â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  âœ… Under limit            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  11. Create Session        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Session created           â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  12. Log MFA Success       â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  SecurityEvent:            â”‚
 â”‚                        â”‚    type: MFA_VERIFY_SUCCESSâ”‚
 â”‚                        â”‚    method: TOTP            â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚  13. Login Success!    â”‚                            â”‚
 â”‚      Token: "eyJ..."   â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  14. Redirect: /dashboard                          â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN WITH MFA!                            â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WRONG CODE SCENARIO:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User enters: 999999 (wrong code)       â”‚
â”‚                                         â”‚
â”‚  System:                                â”‚
â”‚  1. Verify TOTP â†’ âŒ INVALID            â”‚
â”‚  2. Increment rate limit counter: 1/5   â”‚
â”‚  3. Log failed attempt                  â”‚
â”‚  4. Show error: "Invalid code"          â”‚
â”‚                                         â”‚
â”‚  After 5 failed attempts:               â”‚
â”‚  ðŸ”’ LOCKED for 15 minutes               â”‚
â”‚  Email sent: "MFA attempts locked"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Visit login page
2. âŒ¨ï¸ Enter email + password
3. ðŸ“± Open authenticator app on phone
4. ðŸ‘€ Read 6-digit code
5. âŒ¨ï¸ Enter code
6. âœ… Logged in!

**Total Time:** ~20 seconds

---

## FLOW 5: Login with Passkey

**Scenario:** User has Face ID/Touch ID set up, uses biometrics to login

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOGIN WITH PASSKEY (Face ID)                     â”‚
â”‚                  (After Password Verification)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Visit /login       â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Enter Email/Pass   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Verify Password âœ…     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Check MFA Status       â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: UserMFAConfig      â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  passkeyEnabled: true âœ…   â”‚
 â”‚                        â”‚  preferredMethod: "passkey"â”‚
 â”‚                        â”‚                            â”‚
 â”‚  5. Show Passkey Promptâ”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
 â”‚     â”‚  ðŸ”‘ Verify with Passkey      â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  Use Face ID, Touch ID, or   â”‚               â”‚
 â”‚     â”‚  your security key           â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  [Continue with Passkey]     â”‚               â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  6. Click "Continue"   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Get User's Passkeys    â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: WebAuthnCredential â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  Found: 2 passkeys         â”‚
 â”‚                        â”‚    - iPhone Face ID        â”‚
 â”‚                        â”‚    - MacBook Touch ID      â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Generate Challenge     â”‚
 â”‚                        â”‚    (PasskeyService)        â”‚
 â”‚                        â”‚    {                       â”‚
 â”‚                        â”‚      challenge: random(),  â”‚
 â”‚                        â”‚      rpId: "sapgrc.com",   â”‚
 â”‚                        â”‚      allowCredentials: [   â”‚
 â”‚                        â”‚        { id: cred1 },      â”‚
 â”‚                        â”‚        { id: cred2 }       â”‚
 â”‚                        â”‚      ]                     â”‚
 â”‚                        â”‚    }                       â”‚
 â”‚                        â”‚                            â”‚
 â”‚  9. Return Challenge   â”‚                            â”‚
 â”‚     to Browser         â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  10. Browser triggers  â”‚                            â”‚
 â”‚      WebAuthn API:     â”‚                            â”‚
 â”‚      navigator.credentials.get()                    â”‚
 â”‚                        â”‚                            â”‚
 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
 â”‚  â”‚   ðŸŽ macOS System Prompt:    â”‚                  â”‚
 â”‚  â”‚                              â”‚                  â”‚
 â”‚  â”‚   "sapgrc.com wants to       â”‚                  â”‚
 â”‚  â”‚    use your Touch ID"        â”‚                  â”‚
 â”‚  â”‚                              â”‚                  â”‚
 â”‚  â”‚   ðŸ‘† [Touch Sensor to Sign In]â”‚                  â”‚
 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
 â”‚                        â”‚                            â”‚
 â”‚  11. User touches      â”‚                            â”‚
 â”‚      Touch ID sensor   â”‚                            â”‚
 â”‚      ðŸ‘† (biometric)    â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  12. System verifies   â”‚                            â”‚
 â”‚      fingerprint       â”‚                            â”‚
 â”‚      âœ… MATCH!         â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  13. Browser returns   â”‚                            â”‚
 â”‚      signed response   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚      {                 â”‚                            â”‚
 â”‚        credentialId: "xxx",                         â”‚
 â”‚        authenticatorData: "...",                    â”‚
 â”‚        signature: "...",                            â”‚
 â”‚        userHandle: "admin-uuid"                     â”‚
 â”‚      }                 â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  14. Verify Signature      â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Get stored public key     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  publicKey: "..."          â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  15. Verify signature      â”‚
 â”‚                        â”‚      with public key       â”‚
 â”‚                        â”‚      âœ… VALID!             â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  16. Update credential     â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  lastUsed: now()           â”‚
 â”‚                        â”‚  useCount: +1              â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  17. Create Session        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚  18. Login Success!    â”‚                            â”‚
 â”‚      Token: "eyJ..."   â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN WITH FACE ID!                        â”‚
 â”‚     (Most secure + fastest method)                 â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Visit login page
2. âŒ¨ï¸ Enter email + password
3. ðŸ”‘ Click "Continue with Passkey"
4. ðŸ‘† Touch sensor (or look at camera for Face ID)
5. âœ… Logged in!

**Total Time:** ~10 seconds (fastest method!)

---

## FLOW 6: Passwordless Login (Passkey Only)

**Scenario:** User configured passwordless login (no password required!)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PASSWORDLESS LOGIN                               â”‚
â”‚                  (Passkey Only - No Password!)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Visit /login       â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Login Page Shows:  â”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
 â”‚     â”‚  ðŸ“§ Email                    â”‚               â”‚
 â”‚     â”‚  [admin@acme.com___________] â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  ðŸ”’ Password                 â”‚               â”‚
 â”‚     â”‚  [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢] â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  [Sign In]                   â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€ OR â”€â”€â”€â”€â”€â”€â”€â”€        â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚  ðŸ”‘ [Sign in with Passkey]   â”‚               â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
 â”‚                        â”‚                            â”‚
 â”‚  3. Click "Sign in with Passkey" (skip password!)  â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Generate Challenge     â”‚
 â”‚                        â”‚     (no userId yet!)       â”‚
 â”‚                        â”‚    {                       â”‚
 â”‚                        â”‚      challenge: random(),  â”‚
 â”‚                        â”‚      rpId: "sapgrc.com",   â”‚
 â”‚                        â”‚      userVerification: "required"
 â”‚                        â”‚    }                       â”‚
 â”‚                        â”‚                            â”‚
 â”‚  5. Return Challenge   â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  6. Browser prompts:   â”‚                            â”‚
 â”‚      navigator.credentials.get()                    â”‚
 â”‚                        â”‚                            â”‚
 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
 â”‚  â”‚   ðŸŽ "sapgrc.com wants to    â”‚                  â”‚
 â”‚  â”‚       use your passkey"      â”‚                  â”‚
 â”‚  â”‚                              â”‚                  â”‚
 â”‚  â”‚   Available passkeys:        â”‚                  â”‚
 â”‚  â”‚   â€¢ admin@acme.com           â”‚                  â”‚
 â”‚  â”‚                              â”‚                  â”‚
 â”‚  â”‚   ðŸ‘† [Use Touch ID]          â”‚                  â”‚
 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
 â”‚                        â”‚                            â”‚
 â”‚  7. Touch ID Sensor ðŸ‘† â”‚                            â”‚
 â”‚     âœ… Verified!        â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  8. Return Assertion   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚     {                  â”‚                            â”‚
 â”‚       credentialId: "xxx",                          â”‚
 â”‚       signature: "...",                             â”‚
 â”‚       userHandle: "admin-uuid" â¬…ï¸ This identifies user!
 â”‚     }                  â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Look up credential     â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: WebAuthnCredential â”‚
 â”‚                        â”‚  WHERE credentialId = "xxx"â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  userId: "admin-uuid" âœ…   â”‚
 â”‚                        â”‚  publicKey: "..."          â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  10. Verify signature      â”‚
 â”‚                        â”‚      âœ… VALID!             â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  11. Get user info         â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: User               â”‚
 â”‚                        â”‚  WHERE id = admin-uuid     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  User: admin@acme.com      â”‚
 â”‚                        â”‚  roles: ['admin']          â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  12. Create Session        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚  13. Login Success!    â”‚                            â”‚
 â”‚      (NO PASSWORD USED!)                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN - PASSWORDLESS!                      â”‚
 â”‚     ðŸ”’ Most secure (phishing-resistant)            â”‚
 â”‚     âš¡ Fastest (no typing!)                        â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Visit login page
2. ðŸ”‘ Click "Sign in with Passkey" (skip email/password!)
3. ðŸ‘† Touch sensor
4. âœ… Logged in!

**Total Time:** ~3 seconds (FASTEST!)

---

## FLOW 7: New Device/Location Detection

**Scenario:** User logs in from a new device or new location

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                NEW DEVICE/LOCATION DETECTION                        â”‚
â”‚            (Triggers Email Confirmation Workflow)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Login from         â”‚                            â”‚
 â”‚     NEW laptop in      â”‚                            â”‚
 â”‚     NEW location       â”‚                            â”‚
 â”‚     (e.g., Singapore)  â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Enter Credentials  â”‚                            â”‚
 â”‚     Email: admin@acme  â”‚                            â”‚
 â”‚     Password: â€¢â€¢â€¢â€¢â€¢â€¢   â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Verify Password âœ…     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Device Fingerprint     â”‚
 â”‚                        â”‚     deviceId: firefox-win-xxâ”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. GeoIP Lookup           â”‚
 â”‚                        â”‚     IP: 198.12.34.56       â”‚
 â”‚                        â”‚     Location: Singapore    â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  6. Check Device History   â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: TrustedDevice      â”‚
 â”‚                        â”‚  WHERE deviceId = firefox-win
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  âŒ NOT FOUND - NEW DEVICE!â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Check Location History â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: LoginAttempt       â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚    AND location LIKE "Singapore"
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  âŒ NEVER logged in from   â”‚
 â”‚                        â”‚     Singapore before!      â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Calculate Risk Score   â”‚
 â”‚                        â”‚     (RiskAnalyzer)         â”‚
 â”‚                        â”‚     - New Device: +20      â”‚
 â”‚                        â”‚     - New Location: +15    â”‚
 â”‚                        â”‚     - Far from home: +10   â”‚
 â”‚                        â”‚     Risk: 45 (MEDIUM-HIGH) â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  ðŸš¨ DECISION: Require      â”‚
 â”‚                        â”‚     email confirmation!    â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Create Confirmation    â”‚
 â”‚                        â”‚     Token (expires 1hr)    â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  PendingConfirmation:      â”‚
 â”‚                        â”‚    token: uuid()           â”‚
 â”‚                        â”‚    userId: admin-uuid      â”‚
 â”‚                        â”‚    deviceId: firefox-win-xxâ”‚
 â”‚                        â”‚    location: Singapore     â”‚
 â”‚                        â”‚    expiresAt: now() + 1hr  â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  10. Send Email            â”‚
 â”‚                        â”‚      (NewLoginDetector)    â”‚
 â”‚                        â”‚      Template: new-login-confirmation
 â”‚  ðŸ“§ Email Received:    â”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
 â”‚     â”‚ ðŸ”’ New Login Detected          â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ We detected a login from a    â”‚             â”‚
 â”‚     â”‚ device we don't recognize:    â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ Device: Firefox on Windows    â”‚             â”‚
 â”‚     â”‚ Location: Singapore           â”‚             â”‚
 â”‚     â”‚ IP: 198.12.34.56              â”‚             â”‚
 â”‚     â”‚ Time: Oct 23, 2025 10:30 AM   â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ Was this you?                 â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ [âœ… Yes, it was me]            â”‚             â”‚
 â”‚     â”‚ [âŒ No, deny this login]       â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ This link expires in 1 hour.  â”‚             â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
 â”‚                        â”‚                            â”‚
 â”‚  11. Show Pending Page â”‚                            â”‚
 â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
 â”‚      â”‚ ðŸ“§ Email Verification Required â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ For your security, we sent a  â”‚            â”‚
 â”‚      â”‚ verification email to:        â”‚            â”‚
 â”‚      â”‚ admin@acme.com                â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ Please check your email and   â”‚            â”‚
 â”‚      â”‚ click the confirmation link.  â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ â° Link expires in: 59:30     â”‚            â”‚
 â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  â³ User waits for email (1-2 minutes)             â”‚
 â”‚                        â”‚                            â”‚
 â”‚  12. Click "Yes, it    â”‚                            â”‚
 â”‚      was me" in email  â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚      GET /auth/confirm-login?token=xxx             â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  13. Verify Token          â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: PendingConfirmationâ”‚
 â”‚                        â”‚  WHERE token = xxx         â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  âœ… Valid, not expired     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  14. Add to Trusted Devicesâ”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  TrustedDevice:            â”‚
 â”‚                        â”‚    deviceId: firefox-win-xxâ”‚
 â”‚                        â”‚    userId: admin-uuid      â”‚
 â”‚                        â”‚    trustedAt: now()        â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  15. Create Session        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  16. Delete Pending Token  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚  17. Success Page:     â”‚                            â”‚
 â”‚      "Device confirmed!"â”‚                           â”‚
 â”‚      Redirect to /dashboard in 3s                  â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN! Device now trusted.                 â”‚
 â”‚     Future logins from this device: no confirmationâ”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER DENIES LOGIN:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User clicks: "No, deny this login"     â”‚
â”‚                                         â”‚
â”‚  System:                                â”‚
â”‚  1. Delete pending confirmation âŒ      â”‚
â”‚  2. Log security event (DENIED_LOGIN)   â”‚
â”‚  3. Force password reset                â”‚
â”‚  4. Revoke ALL active sessions          â”‚
â”‚  5. Send email: "Your password was reset"
â”‚  6. Add IP to suspicious list           â”‚
â”‚                                         â”‚
â”‚  ðŸ”’ Account secured!                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Login from new device/location
2. âŒ¨ï¸ Enter credentials
3. â³ See "Check your email" message
4. ðŸ“§ Open email (1-2 min wait)
5. âœ… Click "Yes, it was me"
6. âœ… Device trusted, logged in!

**Total Time:** ~3 minutes (one-time setup for new device)

---

## FLOW 8: High-Risk Login (Requires MFA)

**Scenario:** System detects high-risk behavior, forces MFA even if not enabled

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HIGH-RISK LOGIN DETECTION                        â”‚
â”‚           (Forces MFA even if user hasn't set it up)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  1. Login with:        â”‚                            â”‚
 â”‚     - VPN IP           â”‚                            â”‚
 â”‚     - New device       â”‚                            â”‚
 â”‚     - After 3 failed   â”‚                            â”‚
 â”‚       attempts today   â”‚                            â”‚
 â”‚     - At 3 AM (unusual)â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Verify Password âœ… â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Risk Analysis:         â”‚
 â”‚                        â”‚     New Device: +20        â”‚
 â”‚                        â”‚     New Location: +15      â”‚
 â”‚                        â”‚     Recent Failures: +25   â”‚
 â”‚                        â”‚     Unusual Time: +10      â”‚
 â”‚                        â”‚     VPN/Proxy: +10         â”‚
 â”‚                        â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
 â”‚                        â”‚     TOTAL: 80 (HIGH RISK!) â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Check MFA Status       â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  mfaEnabled: false âŒ      â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  ðŸš¨ DECISION: Force MFA    â”‚
 â”‚                        â”‚     even though not set up!â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. Send OTP via Email     â”‚
 â”‚  ðŸ“§ Email:             â”‚                            â”‚
 â”‚     "Your verification code: 739284"               â”‚
 â”‚     "Valid for 10 minutes"                         â”‚
 â”‚                        â”‚                            â”‚
 â”‚  6. Show Challenge:    â”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
 â”‚     â”‚ âš ï¸  High-Risk Login Detected â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚ For your security, we need   â”‚               â”‚
 â”‚     â”‚ to verify your identity.     â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚ We sent a 6-digit code to:   â”‚               â”‚
 â”‚     â”‚ ad***@acme.com               â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚ Enter code: [______]         â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚ [Verify]                     â”‚               â”‚
 â”‚     â”‚                              â”‚               â”‚
 â”‚     â”‚ Didn't receive? [Resend]     â”‚               â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  7. Check email ðŸ“§     â”‚                            â”‚
 â”‚     Code: 739284       â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  8. Enter Code         â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Verify OTP âœ…          â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  10. Show Recommendation   â”‚
 â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
 â”‚      â”‚ âœ… Login Successful            â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ âš ï¸  Important Security Notice  â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ We detected unusual activity.  â”‚            â”‚
 â”‚      â”‚ To protect your account, we    â”‚            â”‚
 â”‚      â”‚ strongly recommend setting up  â”‚            â”‚
 â”‚      â”‚ two-factor authentication.     â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ [Set Up MFA Now] [Skip]        â”‚            â”‚
 â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN (but encouraged to set up MFA)       â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Login in unusual circumstances
2. âŒ¨ï¸ Enter credentials
3. âš ï¸ See "High-risk detected" message
4. ðŸ“§ Check email for OTP code
5. âŒ¨ï¸ Enter code
6. âœ… Logged in (with MFA recommendation)

**Total Time:** ~2 minutes

---

## FLOW 9: Max Sessions Exceeded

**Scenario:** User tries to login but already has 2 active sessions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                MAX SESSIONS EXCEEDED (2/2)                          â”‚
â”‚            (Oldest Session Automatically Evicted)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  Current Sessions:     â”‚                            â”‚
 â”‚  1. Mobile (3 days old)â”‚                            â”‚
 â”‚  2. Work PC (1 day old)â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  Now: Login from       â”‚                            â”‚
 â”‚       Home Laptop      â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  1. Enter Credentials  â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  2. Verify Password âœ…     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Check Active Sessions  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: UserSession        â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚    AND isActive = true     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  Found: 2 sessions âš ï¸      â”‚
 â”‚                        â”‚  - Mobile: 3 days old      â”‚
 â”‚                        â”‚  - Work PC: 1 day old      â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Find Oldest Session    â”‚
 â”‚                        â”‚     Oldest: Mobile (3 days)â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. Revoke Mobile Session  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  UPDATE UserSession        â”‚
 â”‚                        â”‚  SET isActive = false      â”‚
 â”‚                        â”‚  WHERE id = mobile-session â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  6. Delete from Redis      â”‚
 â”‚                        â”‚     (mobile session)       â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Create New Session     â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Laptop session created    â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Send Email Notificationâ”‚
 â”‚  ðŸ“§ To Mobile:         â”‚                            â”‚
 â”‚     "Your session was logged out"                  â”‚
 â”‚     "New login from: Home Laptop"                  â”‚
 â”‚     "If this wasn't you, secure your account"      â”‚
 â”‚                        â”‚                            â”‚
 â”‚  9. Show Notice:       â”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
 â”‚     â”‚ âœ… Login Successful            â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ â„¹ï¸  Session Limit Notice       â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ You can only have 2 active     â”‚             â”‚
 â”‚     â”‚ sessions. Your oldest session  â”‚             â”‚
 â”‚     â”‚ (Mobile, 3 days ago) was       â”‚             â”‚
 â”‚     â”‚ automatically logged out.      â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ [View All Sessions]            â”‚             â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… LOGGED IN!         â”‚                            â”‚
 â”‚     Active sessions:   â”‚                            â”‚
 â”‚     1. Work PC         â”‚                            â”‚
 â”‚     2. Home Laptop (current)                       â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CURRENT SESSION STATE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Active Sessions (2/2):                  â”‚
â”‚                                         â”‚
â”‚ 1ï¸âƒ£  Work PC                            â”‚
â”‚     Last active: 1 day ago              â”‚
â”‚     Location: Office, KL                â”‚
â”‚     [Revoke]                            â”‚
â”‚                                         â”‚
â”‚ 2ï¸âƒ£  Home Laptop (current) ðŸŸ¢          â”‚
â”‚     Last active: just now               â”‚
â”‚     Location: Home, KL                  â”‚
â”‚     This device                         â”‚
â”‚                                         â”‚
â”‚ âŒ Mobile (logged out)                  â”‚
â”‚     Was active: 3 days ago              â”‚
â”‚     Reason: Session limit exceeded      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. ðŸŒ Login from 3rd device
2. âŒ¨ï¸ Enter credentials
3. âœ… Logged in immediately
4. â„¹ï¸ See notice: "Oldest session logged out"
5. ðŸ“§ (Optional) Check email notification

**Total Time:** ~5 seconds

---

## FLOW 10: Password Change (Revokes All Sessions)

**Scenario:** User changes password, all sessions are revoked for security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PASSWORD CHANGE â†’ REVOKE ALL SESSIONS                  â”‚
â”‚                  (Security Best Practice)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER                    SYSTEM                      DATABASE
 â”‚                        â”‚                            â”‚
 â”‚  Currently logged in   â”‚                            â”‚
 â”‚  on 2 devices          â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  1. Go to Settings >   â”‚                            â”‚
 â”‚     Security > Change  â”‚                            â”‚
 â”‚     Password           â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  2. Fill Form:         â”‚                            â”‚
 â”‚     Current: â€¢â€¢â€¢â€¢â€¢â€¢    â”‚                            â”‚
 â”‚     New: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢      â”‚                            â”‚
 â”‚     Confirm: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢  â”‚                            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  3. Verify Current Passwordâ”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  bcrypt.compare()          â”‚
 â”‚                        â”‚  âœ… Correct                â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  4. Hash New Password      â”‚
 â”‚                        â”‚     newHash = bcrypt()     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  5. Update Password        â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  UPDATE User               â”‚
 â”‚                        â”‚  SET passwordHash = newHashâ”‚
 â”‚                        â”‚  WHERE id = admin-uuid     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  6. Get All Active Sessionsâ”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  Query: UserSession        â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚    AND isActive = true     â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  Found: 2 sessions         â”‚
 â”‚                        â”‚  - Laptop (current)        â”‚
 â”‚                        â”‚  - Mobile                  â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  7. Revoke ALL Sessions    â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  UPDATE UserSession        â”‚
 â”‚                        â”‚  SET isActive = false      â”‚
 â”‚                        â”‚  WHERE userId = admin-uuid â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚  âœ… 2 sessions revoked     â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  8. Delete from Redis      â”‚
 â”‚                        â”‚     (all sessions)         â”‚
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  9. Log Security Event     â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚  SecurityEvent:            â”‚
 â”‚                        â”‚    type: PASSWORD_CHANGED  â”‚
 â”‚                        â”‚    sessionsRevoked: 2      â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                        â”‚                            â”‚
 â”‚                        â”‚  10. Send Email to User    â”‚
 â”‚  ðŸ“§ Email:             â”‚                            â”‚
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
 â”‚     â”‚ ðŸ”’ Password Changed            â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ Your password was successfully â”‚             â”‚
 â”‚     â”‚ changed at:                    â”‚             â”‚
 â”‚     â”‚ Oct 23, 2025 2:30 PM           â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ For security, all your active  â”‚             â”‚
 â”‚     â”‚ sessions (2) have been logged  â”‚             â”‚
 â”‚     â”‚ out. Please login again.       â”‚             â”‚
 â”‚     â”‚                                â”‚             â”‚
 â”‚     â”‚ If you didn't make this change,â”‚             â”‚
 â”‚     â”‚ contact support immediately.   â”‚             â”‚
 â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
 â”‚                        â”‚                            â”‚
 â”‚  11. Show Success:     â”‚                            â”‚
 â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
 â”‚      â”‚ âœ… Password Changed            â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ Your password has been updated.â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ âš ï¸  For your security, all     â”‚            â”‚
 â”‚      â”‚     active sessions have been  â”‚            â”‚
 â”‚      â”‚     logged out.                â”‚            â”‚
 â”‚      â”‚                                â”‚            â”‚
 â”‚      â”‚ You will be redirected to      â”‚            â”‚
 â”‚      â”‚ login in 5 seconds...          â”‚            â”‚
 â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  â³ After 5 seconds...                              â”‚
 â”‚                        â”‚                            â”‚
 â”‚  12. Redirect: /login  â”‚                            â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
 â”‚                        â”‚                            â”‚
 â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
 â”‚  ðŸ“± MOBILE DEVICE:                                  â”‚
 â”‚     Next API request returns:                      â”‚
 â”‚     401 Unauthorized                               â”‚
 â”‚     "Session expired, please login again"          â”‚
 â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
 â”‚                        â”‚                            â”‚
 â”‚  âœ… ALL DEVICES LOGGED OUT FOR SECURITY            â”‚
 â”‚                                                      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**User Experience:**
1. âš™ï¸ Go to security settings
2. ðŸ”’ Enter current + new password
3. âœ… See success message
4. â³ Wait 5 seconds
5. âž¡ï¸ Redirected to login
6. ðŸ”‘ Login with new password

**Total Time:** ~1 minute

---

## ðŸ“Š SUMMARY COMPARISON

| Flow | Security Level | User Effort | Time | Frequency |
|------|----------------|-------------|------|-----------|
| **1. Onboarding** | â­â­ Medium | High | ~7 min | Once |
| **2. First Login** | â­â­â­ Medium-High | Medium | ~30 sec | Once |
| **3. Password Only** | â­â­ Medium | Low | ~5 sec | Daily |
| **4. Password + TOTP** | â­â­â­â­ High | Medium | ~20 sec | Daily |
| **5. Password + Passkey** | â­â­â­â­â­ Highest | Low | ~10 sec | Daily |
| **6. Passwordless** | â­â­â­â­â­ Highest | Lowest | ~3 sec | Daily |
| **7. New Device** | â­â­â­â­ High | Medium | ~3 min | Per device |
| **8. High-Risk** | â­â­â­â­ High | Medium | ~2 min | Rare |
| **9. Max Sessions** | â­â­â­ Medium | None | ~5 sec | Occasional |
| **10. Password Change** | â­â­â­â­ High | Medium | ~1 min | Rare |

---

## ðŸŽ¯ RECOMMENDED USER JOURNEY

**For Best Security + UX:**

```
Day 1: Onboarding (7 min, one-time)
  â†“
Day 1: First Login (30 sec)
  â†“
Day 1: Set up Passkey (2 min, one-time)
  â†“
Day 2+: Passwordless Login (3 sec, daily)
  âœ… FASTEST + MOST SECURE!
```

**Alternative (if passkeys not available):**

```
Day 1: Onboarding
  â†“
Day 1: Set up TOTP (3 min, one-time)
  â†“
Day 2+: Password + TOTP (20 sec, daily)
  âœ… SECURE + REASONABLE
```

---

## ðŸ’¡ KEY INSIGHTS

1. **Passwordless is fastest** (3 sec) and most secure (phishing-resistant)
2. **New device confirmation** adds friction (3 min) but prevents account takeover
3. **Max 2 sessions** is transparent to users (auto-eviction)
4. **Risk-based auth** adapts security to threat level
5. **Password change â†’ logout all** is critical security measure

---

**This flow documentation should be shared with:**
- âœ… Product team (UX decisions)
- âœ… Security team (risk analysis)
- âœ… Support team (user questions)
- âœ… Developers (implementation guide)
